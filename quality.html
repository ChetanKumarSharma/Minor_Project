<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ECO SMART ANALYZER — Air & Water Quality</title>

  <!-- Chart.js and date adapter (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

  <style>
    :root{
      --accent:#1fa67a;
      --accent-2:#2bb673;
      --muted:#6b7280;
      --card:#ffffffcc;
      --shadow: 0 8px 30px rgba(16,24,40,0.08);
      --radius:12px;
      --max-width:1100px;
      --glass: rgba(255,255,255,0.6);
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial; margin:0; background:linear-gradient(120deg,#e6fff2 0%, #f0fff9 100%); color:#07251f; -webkit-font-smoothing:antialiased;}
    .container{max-width:var(--max-width); margin:28px auto; padding:18px;}
    header{display:flex;align-items:center;justify-content:space-between; gap:12px; background:var(--glass); padding:14px 18px; border-radius:12px; box-shadow:var(--shadow); position:sticky; top:12px; z-index:20;}
    header h1{margin:0; font-family:Merriweather,serif; color:#064e3b; font-size:20px;}
    nav a{color:#064e3b; text-decoration:none; margin-left:12px; font-weight:600}
    .controls{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:18px; align-items:end;}
    .control, .control-inline{background:var(--card); padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(10,20,10,0.04);}
    .control label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px;}
    select,input[type="date"]{width:100%; padding:8px 10px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); font-size:14px;}
    .btn{display:inline-flex; gap:8px; align-items:center; padding:8px 12px; border-radius:10px; border:0; cursor:pointer; font-weight:700; color:white; background:linear-gradient(90deg,var(--accent),var(--accent-2));}
    .btn.secondary{background:transparent; color:var(--accent-2); border:1px solid rgba(43,128,90,0.12);}
    .flex{display:flex; gap:12px; align-items:center;}
    .charts{display:grid; grid-template-columns:1fr; gap:14px; margin-top:18px;}
    .chart-card{background:var(--card); padding:12px; border-radius:10px; box-shadow:var(--shadow);}
    .table-card{margin-top:18px; background:var(--card); padding:12px; border-radius:10px; box-shadow:var(--shadow);}
    table{width:100%; border-collapse:collapse; font-size:13px;}
    th,td{padding:8px 10px; border-bottom:1px solid rgba(0,0,0,0.06); text-align:left;}
    th{background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:white; position:sticky; top:0;}
    .summary{display:flex; gap:12px; flex-wrap:wrap; margin-top:12px;}
    .summary .item{background:#fff; padding:10px 12px; border-radius:8px; box-shadow:0 6px 18px rgba(10,20,10,0.04); min-width:160px;}
    .muted{color:var(--muted)}
    @media (max-width:980px){
      .controls{grid-template-columns:1fr; align-items:stretch}
      header{flex-direction:column; align-items:flex-start; gap:10px}
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div>
        <h1>ECO SMART ANALYZER</h1>
        <div class="muted" style="font-size:13px">Air & Water Quality — Delhi</div>
      </div>
      <nav aria-label="top links">
        <a href="index.html">Home</a>
        <a href="compare.html">Compare</a>
        <a href="footprint.html">Footprint</a>
      </nav>
    </header>

    <!-- Controls -->
    <div class="controls" role="region" aria-label="Filters and actions">
      <div class="control">
        <label for="datasetSelect">Dataset</label>
        <select id="datasetSelect" aria-label="Choose dataset">
          <option value="both">Both (Air & Water)</option>
          <option value="air">Air Quality</option>
          <option value="water">Water Quality</option>
        </select>
      </div>

      <div class="control">
        <label for="regionSelect">Region</label>
        <select id="regionSelect" aria-label="Choose region">
          <option value="All">All Regions</option>
        </select>
      </div>

      <div class="control">
        <label>Date range</label>
        <div style="display:flex; gap:8px;">
          <input type="date" id="dateFrom" aria-label="Start date">
          <input type="date" id="dateTo" aria-label="End date">
        </div>
      </div>

      <div class="control">
        <label for="airParam">Air parameter</label>
        <select id="airParam">
          <option>PM2.5</option>
          <option>PM10</option>
          <option>NO2</option>
          <option>SO2</option>
        </select>
      </div>

      <div class="control">
        <label for="waterParam">Water parameter</label>
        <select id="waterParam">
          <option>pH</option>
          <option>Turbidity</option>
          <option>Lead</option>
          <option>Nitrate</option>
        </select>
      </div>

      <div class="control" style="display:flex; gap:8px; align-items:center; justify-content:flex-end;">
        <div class="flex">
          <button id="applyBtn" class="btn">Apply</button>
          <button id="resetBtn" class="btn secondary">Reset</button>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts" id="chartsArea" aria-live="polite">
      <div class="chart-card" id="airChartCard" style="display:none;">
        <canvas id="airChart" height="160" aria-label="Air quality chart"></canvas>
      </div>

      <div class="chart-card" id="waterChartCard" style="display:none;">
        <canvas id="waterChart" height="160" aria-label="Water quality chart"></canvas>
      </div>

      <div class="chart-card" id="combinedCard" style="display:none;">
        <h3 style="margin:0 0 8px 0">Region Comparison (Selected Parameter)</h3>
        <div class="summary" id="summaryArea" role="region" aria-label="Summary statistics"></div>
      </div>
    </div>

    <!-- Tables and actions -->
    <div class="table-card" id="tableCard">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
        <h3 style="margin:0">Filtered Data</h3>
        <div style="display:flex; gap:8px;">
          <button id="exportBtn" class="btn secondary">Export CSV</button>
          <button id="copyBtn" class="btn">Copy Table</button>
        </div>
      </div>

      <div style="margin-top:12px; overflow:auto;">
        <table id="dataTable" aria-live="polite">
          <!-- Filled by JS -->
        </table>
      </div>
    </div>
  </div>

  <script>
  
/* Air and Water Quality Data*/

const airCSV = `Date,Region,PM2.5,PM10,NO2,SO2
2025-11-01,Connaught Place,85,120,40,20
2025-11-01,Anand Vihar,110,160,55,22
2025-11-01,Rohini,90,140,63,45
2025-11-02,Rajouri Garden,80,115,42,11
2025-11-02,Madhuban Chowk,105,155,50,13
2025-11-02,Civil Lines,95,145,41,10
2025-11-03,Vidhan Sabha,78,112,39,94
2025-11-03,VishwaVidhalay,100,150,48,12
2025-11-03,Netaji Subash Place,92,142,40,77`;

const waterCSV = `Date,Region,pH,Turbidity,Lead,Nitrate
2025-11-01,Connaught Place,4.2,3.5,8.5,12
2025-11-01,Anand Vihar,7.4,4.9,4.5,15
2025-11-01,Rohini,4.1,5.8,2.5,13
2025-11-02,Rajouri Garden,9.3,3.6,2.01,11
2025-11-02,Madhuban Chowk,8.0,4.1,3.02,14
2025-11-02,Civil Lines,4.2,9.9,7.015,12
2025-11-03,Vidhan Sabha,3.1,6.5,9.012,14
2025-11-03,VishwaVidhalay,6.0,4.0,4.018,15
2025-11-03,Netaji Subash Place,9.2,4.7,3.014,45`;

/* CSV parsing utility */
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/).filter(Boolean);
  const headers = lines[0].split(',').map(h=>h.trim());
  const rows = lines.slice(1).map(line=>{
    // split but keep numeric values as numbers where possible
    const cols = line.split(',').map(c=>c.trim());
    const obj = {};
    headers.forEach((h,i)=>{
      let v = cols[i] ?? '';
      // convert numeric fields (but keep Region and Date as strings)
      if(h !== 'Region' && h !== 'Date'){
        const num = Number(v);
        v = isNaN(num) ? v : num;
      }
      obj[h] = v;
    });
    // convert Date to Date object for easier filtering
    obj.DateObj = new Date(obj.Date);
    return obj;
  });
  return rows;
}

/* Data initialization */
const airData = parseCSV(airCSV);
const waterData = parseCSV(waterCSV);

/* Build region list from both datasets */
const allRegions = Array.from(new Set([...airData.map(d=>d.Region), ...waterData.map(d=>d.Region)])).sort();

/* DOM references */
const datasetSelect = document.getElementById('datasetSelect');
const regionSelect = document.getElementById('regionSelect');
const dateFrom = document.getElementById('dateFrom');
const dateTo = document.getElementById('dateTo');
const airParam = document.getElementById('airParam');
const waterParam = document.getElementById('waterParam');
const applyBtn = document.getElementById('applyBtn');
const resetBtn = document.getElementById('resetBtn');
const airChartCard = document.getElementById('airChartCard');
const waterChartCard = document.getElementById('waterChartCard');
const combinedCard = document.getElementById('combinedCard');
const summaryArea = document.getElementById('summaryArea');
const dataTable = document.getElementById('dataTable');
const exportBtn = document.getElementById('exportBtn');
const copyBtn = document.getElementById('copyBtn');

let airChart = null;
let waterChart = null;

/* Populate region select and date inputs */
function initControls(){
  // regions
  regionSelect.innerHTML = '<option value="All">All Regions</option>';
  allRegions.forEach(r=>{
    const opt = document.createElement('option');
    opt.value = r;
    opt.textContent = r;
    regionSelect.appendChild(opt);
  });

  // date range from combined data
  const allDates = [...airData, ...waterData].map(d=>d.DateObj.getTime());
  const minDate = new Date(Math.min(...allDates));
  const maxDate = new Date(Math.max(...allDates));
  dateFrom.value = toInputDate(minDate);
  dateTo.value = toInputDate(maxDate);
  dateFrom.min = toInputDate(minDate);
  dateFrom.max = toInputDate(maxDate);
  dateTo.min = toInputDate(minDate);
  dateTo.max = toInputDate(maxDate);
}
function toInputDate(d){
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

/* Filtering helpers */
function filterData(dataset, region, from, to){
  const fromT = new Date(from).getTime();
  const toT = new Date(to).getTime() + 24*60*60*1000 - 1; // include end day
  return dataset.filter(d=>{
    const t = d.DateObj.getTime();
    if(t < fromT || t > toT) return false;
    if(region && region !== 'All' && d.Region !== region) return false;
    return true;
  }).sort((a,b)=>a.DateObj - b.DateObj);
}

/* Chart creation helpers */
function createLineChart(ctx, datasets, label){
  return new Chart(ctx, {
    type: 'line',
    data: { datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' },
        title: { display: true, text: label, font: { size: 16 } }
      },
      scales: {
        x: {
          type: 'time',
          time: { unit: 'day', tooltipFormat: 'yyyy-MM-dd' },
          title: { display: true, text: 'Date' }
        },
        y: {
          beginAtZero: false,
          title: { display: true, text: label }
        }
      },
      elements: { point: { radius: 3 } }
    }
  });
}

/* Render functions */
function render(){
  const dataset = datasetSelect.value;
  const region = regionSelect.value;
  const from = dateFrom.value;
  const to = dateTo.value;
  const selectedAirParam = airParam.value;
  const selectedWaterParam = waterParam.value;

  // Filtered sets
  const filteredAir = filterData(airData, region, from, to);
  const filteredWater = filterData(waterData, region, from, to);

  // Show/hide chart cards
  airChartCard.style.display = (dataset === 'air' || dataset === 'both') && filteredAir.length ? 'block' : 'none';
  waterChartCard.style.display = (dataset === 'water' || dataset === 'both') && filteredWater.length ? 'block' : 'none';
  combinedCard.style.display = 'block';

  // Destroy previous charts
  if(airChart){ airChart.destroy(); airChart = null; }
  if(waterChart){ waterChart.destroy(); waterChart = null; }

  // Build air chart (one parameter at a time)
  if((dataset === 'air' || dataset === 'both') && filteredAir.length){
    const regions = Array.from(new Set(filteredAir.map(d=>d.Region)));
    const datasets = regions.map((r, idx)=>{
      const color = `hsl(${(idx*60)%360} 70% 45%)`;
      const points = filteredAir.filter(d=>d.Region===r).map(d=>({x:d.DateObj, y: Number(d[selectedAirParam])}));
      return { label: r, data: points, borderColor: color, backgroundColor: color, tension:0.2, fill:false };
    });
    const ctx = document.getElementById('airChart').getContext('2d');
    airChart = createLineChart(ctx, datasets, `Air — ${selectedAirParam}`);
  }

  // Build water chart
  if((dataset === 'water' || dataset === 'both') && filteredWater.length){
    const regions = Array.from(new Set(filteredWater.map(d=>d.Region)));
    const datasets = regions.map((r, idx)=>{
      const color = `hsl(${(idx*60+30)%360} 70% 45%)`;
      const points = filteredWater.filter(d=>d.Region===r).map(d=>({x:d.DateObj, y: Number(d[selectedWaterParam])}));
      return { label: r, data: points, borderColor: color, backgroundColor: color, tension:0.2, fill:false };
    });
    const ctx = document.getElementById('waterChart').getContext('2d');
    waterChart = createLineChart(ctx, datasets, `Water — ${selectedWaterParam}`);
  }

  // Summary: compute min/avg/max per region for the selected parameter(s)
  summaryArea.innerHTML = '';
  if(dataset === 'air' || dataset === 'both'){
    const param = selectedAirParam;
    const regions = Array.from(new Set(filteredAir.map(d=>d.Region)));
    regions.forEach(r=>{
      const vals = filteredAir.filter(d=>d.Region===r).map(d=>Number(d[param])).filter(v=>!isNaN(v));
      if(!vals.length) return;
      const avg = (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2);
      const min = Math.min(...vals);
      const max = Math.max(...vals);
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `<strong>${r}</strong><div class="muted">${param} — avg: ${avg}, min: ${min}, max: ${max}</div>`;
      summaryArea.appendChild(el);
    });
  }
  if(dataset === 'water' || dataset === 'both'){
    const param = selectedWaterParam;
    const regions = Array.from(new Set(filteredWater.map(d=>d.Region)));
    regions.forEach(r=>{
      const vals = filteredWater.filter(d=>d.Region===r).map(d=>Number(d[param])).filter(v=>!isNaN(v));
      if(!vals.length) return;
      const avg = (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(3);
      const min = Math.min(...vals);
      const max = Math.max(...vals);
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `<strong>${r}</strong><div class="muted">${param} — avg: ${avg}, min: ${min}, max: ${max}</div>`;
      summaryArea.appendChild(el);
    });
  }

  // Build combined table (air rows then water rows)
  buildTable(filteredAir, filteredWater, dataset);
}

/* Table rendering */
function buildTable(airRows, waterRows, dataset){
  // Determine columns
  let html = '';
  if(dataset === 'air'){
    html += `<thead><tr><th>Date</th><th>Region</th><th>PM2.5</th><th>PM10</th><th>NO2</th><th>SO2</th></tr></thead><tbody>`;
    airRows.forEach(r=>{
      html += `<tr><td>${r.Date}</td><td>${r.Region}</td><td>${r['PM2.5']}</td><td>${r['PM10']}</td><td>${r['NO2']}</td><td>${r['SO2']}</td></tr>`;
    });
    html += `</tbody>`;
  } else if(dataset === 'water'){
    html += `<thead><tr><th>Date</th><th>Region</th><th>pH</th><th>Turbidity</th><th>Lead</th><th>Nitrate</th></tr></thead><tbody>`;
    waterRows.forEach(r=>{
      html += `<tr><td>${r.Date}</td><td>${r.Region}</td><td>${r['pH']}</td><td>${r['Turbidity']}</td><td>${r['Lead']}</td><td>${r['Nitrate']}</td></tr>`;
    });
    html += `</tbody>`;
  } else { // both
    // show air first then water with a separator row
    html += `<thead><tr><th>Date</th><th>Region</th><th>Type</th><th>Param A</th><th>Param B</th><th>Param C</th></tr></thead><tbody>`;
    // Air rows: show PM2.5, PM10, NO2, SO2 in columns 4-7 (we'll show first three numeric columns)
    airRows.forEach(r=>{
      html += `<tr><td>${r.Date}</td><td>${r.Region}</td><td>Air</td><td>PM2.5: ${r['PM2.5']}</td><td>PM10: ${r['PM10']}</td><td>NO2: ${r['NO2']}</td></tr>`;
    });
    // Separator
    html += `<tr style="background:#f3f7f4"><td colspan="6" style="text-align:center;font-weight:700">Water Quality</td></tr>`;
    waterRows.forEach(r=>{
      html += `<tr><td>${r.Date}</td><td>${r.Region}</td><td>Water</td><td>pH: ${r['pH']}</td><td>Turbidity: ${r['Turbidity']}</td><td>Lead: ${r['Lead']}</td></tr>`;
    });
    html += `</tbody>`;
  }
  dataTable.innerHTML = html;
}

/* Export and copy utilities */
function tableToCSV(){
  const rows = Array.from(dataTable.querySelectorAll('tr'));
  const csv = rows.map(tr=>{
    const cols = Array.from(tr.querySelectorAll('th,td')).map(td=>{
      // escape quotes
      return `"${String(td.textContent).replace(/"/g,'""')}"`;
    });
    return cols.join(',');
  }).join('\n');
  return csv;
}
function downloadCSV(filename, text){
  const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* Event wiring */
applyBtn.addEventListener('click', ()=> {
  render();
});
resetBtn.addEventListener('click', ()=>{
  datasetSelect.value = 'both';
  regionSelect.value = 'All';
  initControls(); // resets dates
  airParam.value = 'PM2.5';
  waterParam.value = 'pH';
  render();
});
exportBtn.addEventListener('click', ()=>{
  const csv = tableToCSV();
  downloadCSV('quality_filtered.csv', csv);
});
copyBtn.addEventListener('click', async ()=>{
  const csv = tableToCSV();
  try{
    await navigator.clipboard.writeText(csv);
    alert('Table copied to clipboard (CSV format).');
  }catch(e){
    alert('Copy failed. You can export CSV instead.');
  }
});

/* Initialize and render default */
initControls();
render();

  </script>
</body>
</html>
